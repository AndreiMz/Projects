<h1>Welcome!</h1>



<div class="search-field">
<%= text_field_tag :user, nil, class: "typeahead js-user-autocomplete", placeholder: "Search..." %>
</div>


<div id="map"></div>


<script>
  function htmlDecode(input){
    var e = document.createElement('div');
    e.innerHTML = input;
    // handle case of empty input
    return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
  }

  var map;
  var markers = [];

  breweries = JSON.parse(htmlDecode("<%=@json_breweries%>"));

  function initMap() {
    var info_window = null;
    var buc_center = {lat:44.427807, lng:26.102521}

    map = new google.maps.Map(document.getElementById('map'), {
      center: buc_center,
      zoom: 14
    });

    breweries.forEach(function (brewery, i) {

      markers[brewery.id] = new google.maps.Marker({
        position: {lat: brewery.brewery_latitude, lng: brewery.brewery_longitude},
        map: map
      });

      
      markers[brewery.id].addListener('click', function() {
        all_beers = ""

        for (b in brewery.beers) {
          all_beers += brewery.beers[b] + "<br>"
        }
        if (info_window){
          info_window.close();

        }
        info_window = new google.maps.InfoWindow({
            content: '<strong>' + brewery.brewery_name + '</strong>' + '<br>' + all_beers
          });
        info_window.open(map, markers[brewery.id]);
      });
    });
   
   fitToBounds(map,markers);  
  }

if(window.google){
  initMap();
} else{
  $.ajax('https://maps.googleapis.com/maps/api/js?key=AIzaSyCVrtzcmMfKSN5Ez8ok6PjJX49c81Uxwec&callback=initMap', {
    crossDomain: true,
    dataType: 'script'
  });
}
function clearOverlays(markers) {
 markers.forEach(function (marker, i) {
      marker.setMap(null);    
  });
}


$('.js-user-autocomplete').on('keyup', function(e) {
  if(e.which == 13) {
    setMarkersFromSearch();
  }
});


$('.js-user-autocomplete').on('typeahead:selected', function(e) {
  setMarkersFromSearch();
});

function setMarkersFromSearch() {
  clearOverlays(markers);
  setMapOnAll(map, window.breweries);
  fitToBounds(map,markers);
}

function fitToBounds(map,markers) {
  var bounds = new google.maps.LatLngBounds(null);

  markers.forEach(function (marker) {
    if(marker.getMap())
      bounds.extend(marker.getPosition());    
  });

  map.fitBounds(bounds);

  map.panToBounds(bounds);
  
}


// Sets the map on all markers in the array.
function setMapOnAll(map, markersToEnable) {
  for (var i = 0; i < markersToEnable.length; i++) {
    markers[markersToEnable[i]].setMap(map);
  }
}

</script>

<br>
<br>
<br>
<footer align="center" style="text-align:center;">
  Â© Andrei,Gregor,Gabriel,Andrei HummingCode Squad.
</footer>